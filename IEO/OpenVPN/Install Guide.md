# Acces OpenVPN-2160 Instance
# pyenv shell OpenVPN-2160-01
pct accesss 108

# Enable SSH access - https://www.cyberciti.biz/faq/linux-unix-openssh-block-root-user/#:~:text=To%20disable%20SSH%20logins%20for%20the%20root%20account%3A,server%20in%20order%20to%20deny%20root%20log%20in
#nano /etc/ssh/sshd_config
echo \
"PermitRootLogin yes" | tee /etc/ssh/sshd_config > /dev/null 

# OpenVPN install Guide
https://pve.proxmox.com/wiki/OpenVPN_in_LXC

# Copy client OVPN file out using SCP
/root

==========================

# Following Config for VPS hosted

# OpenVPN install Guide
apt update
apt dist-upgrade
apt install openvpn git

git clone https://github.com/Nyr/openvpn-install
cd openvpn-install
bash openvpn-install.sh
> TCP
> 2100
> EarthDevClient

# save original iptables
iptables-save > /etc/network/iptables.orig

# Reset iptables
sudo bash -c "ufw -f reset && iptables -F && iptables -X && ufw allow 22/tcp && ufw allow 2100/udp &&  ufw allow 17171/tcp &&ufw -f enable"

# add custome iptables
iptables -A FORWARD -i tun0 -p udp -m multiport --dports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p tcp -m multiport --dports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p udp -m multiport --sports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p tcp -m multiport --sports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p icmp -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -s 10.21.0.0/24 -d 10.21.0.0/24 -j DROP
iptables -A FORWARD -i tun0 -s 0.0.0.0/0 -d 0.0.0.0/0 -j DROP

# Redirecting network traffic to a new IP using IPtables - https://www.debuntu.org/how-to-redirecting-network-traffic-to-a-new-ip-using-iptables/
iptables -t nat -A PREROUTING -p tcp --dport 17171 -j DNAT --to-destination 10.21.0.1:17171

# finally, we ask IPtables to masquerade:
sudo iptables -t nat -A POSTROUTING -j MASQUERADE

# save iptables
iptables-save
iptables-save > /etc/network/iptables

# edit iptables and ensuirre it looks like example below
nano /etc/network/iptables

## iptables example
# Generated by iptables-save v1.8.7 on Wed Apr  5 10:40:14 2023
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -p udp -m udp --dport 2100 -j ACCEPT
-A FORWARD -s 10.21.0.0/24 -d 10.21.0.0/24 -i tun0 -p udp -m multiport --dports 6073,2300:2400,47624 -j ACCEPT
-A FORWARD -s 10.21.0.0/24 -d 10.21.0.0/24 -i tun0 -p tcp -m multiport --dports 6073,2300:2400,47624 -j ACCEPT
-A FORWARD -s 10.21.0.0/24 -d 10.21.0.0/24 -i tun0 -p udp -m multiport --sports 6073,2300:2400,47624 -j ACCEPT
-A FORWARD -s 10.21.0.0/24 -d 10.21.0.0/24 -i tun0 -p tcp -m multiport --sports 6073,2300:2400,47624 -j ACCEPT
-A FORWARD -s 10.21.0.0/24 -d 10.21.0.0/24 -i tun0 -p icmp -j ACCEPT
-A FORWARD -s 10.21.0.0/24 -d 10.21.0.0/24 -i tun0 -j DROP
-A FORWARD -i tun0 -j DROP
COMMIT
# Completed on Wed Apr  5 10:40:14 2023


# Create script to auto apply on reboot
nano /etc/network/if-up.d/ovpniptables

#!/bin/sh

yes | iptables-apply /etc/network/iptables


# make script executable
chmod +x /etc/network/if-up.d/ovpniptables 

==========================

# Following Config for self hosted
# Apply traffic restriction
iptables -A FORWARD -i tun0 -p udp -m multiport --dports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p tcp -m multiport --dports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p udp -m multiport --sports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p tcp -m multiport --sports 6073,2300:2400,47624 -s 10.21.0.0/24 -d 10.21.0.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -p icmp -s 10.21.00.0/24 -d 10.21.00.0/24 -j ACCEPT
iptables -A FORWARD -i tun0 -s 10.21.00.0/24 -d 10.21.00.0/24 -j DROP
iptables -A FORWARD -i tun0 -s 0.0.0.0/0 -d 0.0.0.0/0 -j DROP

# Redirecting network traffic to a new IP using IPtables - https://www.debuntu.org/how-to-redirecting-network-traffic-to-a-new-ip-using-iptables/
iptables -t nat -A PREROUTING -p tcp --dport 17171 -j DNAT --to-destination 10.21.0.1:17171

iptables-save
iptables-save > /etc/network/iptables
iptables-apply /etc/network/iptables

# Create script to auto apply on reboot
nano /etc/network/if-up.d/ovpniptables

#!/bin/sh

yes | iptables-apply /etc/network/iptables

# make script executable
chmod +x /etc/network/if-up.d/ovpniptables 

========================
# Check services are running
systemctl | grep openvpn

# restart services
service openvpn stop
service openvpn-iptables stop
service openvpn-server stop
service openvpn start
service openvpn-iptables start
service openvpn-server start

# Server Config Path
/etc/openvpn

# Log Paths
/etc/openvpn/server/openvpn-E2160-status.log
/var/log/openvpn/openvpn_E2160.log

========================= server.conf

# local 10.21.59.249
port 2100
proto udp
dev tun
verb 3

### Certificates
ca ca.crt
cert server.crt
key server.key
dh dh.pem
crl-verify crl.pem
tls-crypt tc.key

### Authentication and Ciphers
auth SHA512
cipher AES-256-GCM
tls-version-min 1.2

server 10.21.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
keepalive 10 120
user nobody
group nogroup
persist-key
persist-tun

### Notify the client that when the server restarts so it
### can automatically reconnect.
explicit-exit-notify 1

### Route Configurations Below
### Override the Client default gateway by using 0.0.0.0/1 and
### 128.0.0.0/1 rather than 0.0.0.0/0. This has the benefit of
### overriding but not wiping out the original default gateway.
### route 10.21.0.0 255.255.255.0

### Logging
status openvpn-E2160-status.log
log /var/log/openvpn/openvpn_E2160.log

### DuplicateCNs allow access control on a less-granular, per user basis.
### Remove # if you will manage access by user instead of device.
duplicate-cn

### Extra Configurations Below
topology subnet

### Prevent DNS leaks on Windows
push "block-outside-dns"

### Push Configurations Below
### push "route 10.21.0.0 255.255.255.0"
### push "dhcp-option DNS 0.0.0.0"
### push "dhcp-option DNS 0.0.0.0"
### push "dhcp-option DNS 9.9.9.9"
### push "dhcp-option DNS 149.112.112.112"
### push "redirect-gateway def1 bypass-dhcp"

================== Client .ovpn config

client
dev tun
proto udp
remote earthnet.insideearth.info 2100
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
auth SHA512
cipher AES-256-GCM
route-nopull
route 10.21.0.0 255.255.255.0
ignore-unknown-option block-outside-dns
explicit-exit-notify 1
verb 3

